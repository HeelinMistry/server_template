name: üìö Auto-Generate API Documentation

on:
  push:
    branches:
      - main # Trigger on push to the main branch
    paths-ignore:
      - 'docs/api/**' # IGNORE documentation changes to prevent infinite loops
      - '**/*.md'     # IGNORE changes to Markdown files (like the output README)
  pull_request:
    types: [closed]
    branches:
      - main # Also run when a PR is merged into main (ensures latest docs)

jobs:
  build_and_commit_docs:
    runs-on: ubuntu-latest
    permissions:
      contents: write # REQUIRED for the git-auto-commit-action to push changes

    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v4
        with:
          # REQUIRED: The auto-commit action needs the full history, not just the head commit
          fetch-depth: 0

      - name: üõ†Ô∏è Setup Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: '20' # Use a modern, stable Node version

      - name: üì¶ Install Project Dependencies
        run: npm ci # Use 'ci' for faster, cleaner dependency install in CI environments

      - name: üìù Install JSDoc-to-Markdown Tool
        # Install the generator tool needed to create the Markdown file
        run: npm install --save-dev jsdoc-to-markdown

      - name: üìú Generate API Documentation (Markdown)
        run: |
          cd server_template
          npx jsdoc2md --files 'controllers/*.js' 'services/*.js' > API_REFERENCE.md

      - name: ‚¨ÜÔ∏è Commit and Push Documentation Update
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          # Only commit the generated documentation file
          files: API_REFERENCE.md
          commit_message: "docs: Auto-update API Reference [skip ci]" # Skip CI to avoid loop
          branch: main
